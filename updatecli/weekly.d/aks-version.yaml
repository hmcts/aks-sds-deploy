---
version: 0.33.3
title: "Update aks version"

scms:
  default:
    kind: github
    spec:
      user: {{ .github.user }}
      email: {{ .github.email }}
      owner: {{ .github.owner }}
      repository: {{ .github.repository }}
      token: {{ or .github.token (requiredEnv "UPDATECLI_GITHUB_TOKEN") }}
      username: {{ or .github.user (requiredEnv "UPDATECLI_GITHUB_ACTOR") }}
      branch: {{ or .github.branch "main" }}

sources:
  latestAksVersion:
    kind: shell
    name: Get latest AKS version for a given region
    spec:
      command: az aks get-versions --location uksouth --query orchestrators[?default].orchestratorVersion -o tsv
      versionfilter:
        kind: semver
    transformers:
      - findsubmatch:
          pattern: ((\d+\.)?(\d+))?(\*|\.\d+)
          captureindex: 1

targets:
  sbox:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/sbox.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  demo:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/demo.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  dev:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/dev.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  ithc:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/ithc.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  ptlsbox:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/ptlsbox.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  ptl:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/ptl.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  stg:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/stg.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  test:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/test.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'
  prod:
    sourceid: latestAksVersion
    name: Bump major AKS version
    kind: file
    scmid: default
    spec:
      file: "environments/aks/prod.tfvars"
      matchpattern: 'kubernetes_version = \"(\d+\.)?(\d+\.)?(\*|\d+)\"'
      content: 'kubernetes_version  = "{{ source `latestAksVersion` }}"'


pullrequests:
  sbox:
    kind: github
    scmid: default
    title: >
      [updatecli] [sbox] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  demo:
    kind: github
    scmid: default
    title: >
      [updatecli] [demo] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  dev:
    kind: github
    scmid: default
    title: >
      [updatecli] [dev] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  ithc:
    kind: github
    scmid: default
    title: >
      [updatecli] [ithc] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  ptlsbox:
    kind: github
    scmid: default
    title: >
      [updatecli] [ptlsbox] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  ptl:
    kind: github
    scmid: default
    title: >
      [updatecli] [ptl] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  stg:
    kind: github
    scmid: default
    title: >
      [updatecli] [stg] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  test:
    kind: github
    scmid: default
    title: >
      [updatecli] [test] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
  prod:
    kind: github
    scmid: default
    title: >
      [updatecli] [prod] Bump major aks version to {{ source "latestAksVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump major aks version to {{ source "latestAksVersion" }}
