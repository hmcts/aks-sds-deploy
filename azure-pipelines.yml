name: ${{ parameters.overrideAction }} - ${{ parameters.env }}.${{ parameters.cluster }}.${{ parameters.location }}

trigger:
  batch: true
  branches:
    include:
    - master

resources:
  repositories:
  - repository: cnp-azuredevops-libraries
    type: github
    ref: master
    name: hmcts/cnp-azuredevops-libraries
    endpoint: 'hmcts-PlatformOperations'

variables:
  - name: agentPool
    value: "ubuntu-latest" 
  - name: build
    value: $(Build.BuildNumber)
  - name: product
    value: "sds-platform"
  - name: terraformInitSubscription
    value: 04d27a32-7a07-48b3-95b8-3c8691e1a263
  - template: vars/input-variables.yaml@cnp-azuredevops-libraries
  - name: serviceConnection
    value: OPS-APPROVAL-GATE-${{ parameters.env }}-ENVS
  - name: action
    value: ${{ parameters.overrideAction }}
  - name: project
    value: ss

parameters:
  - name: overrideAction
    displayName: Action
    type: string
    default: "plan"
    values:
      - plan
      - apply


  - name: cluster
    displayName: Cluster
    type: string
    default: "All"
    values:
      - "All"
      - "00"
      - "01"

  - name: location
    displayName: Location
    type: string
    default: "UK South"
    values:
      - "UK South"
      - "UK West"

  - name: env
    displayName: Environment
    type: string
    default: "sbox"
    values:
      - ithc
      - dev
      - demo
      - sbox
      - ptlsbox
      - test
      - stg
      - ptl
      - prod
      
  - name: environment_components
    type: object
    default:
    - deployment: demo_genesis
      environment: demo
      component: "00-genesis"
    
    - deployment: demo_network_rg
      environment: demo
      component: "07-network-rg"
      dependsOn:
        - demo_genesis

    - deployment: demo_network
      environment: demo
      component: "01-network"
      dependsOn:
        - demo_network_rg
    
    - deployment: demo_mis
      environment: demo
      component: "05-mis"
      dependsOn:
        - demo_network

    - deployment: demo_aks
      environment: demo
      component: "aks"
      dependsOn:
        - demo_mis

    - deployment: dev_genesis
      environment: dev
      component: "00-genesis"
 
    - deployment: dev_network_rg
      environment: dev
      component: "07-network-rg"
      dependsOn:
        - dev_genesis

    - deployment: dev_network
      environment: dev
      component: "01-network"
      dependsOn:
        - dev_network_rg
    
    - deployment: dev_mis
      environment: dev
      component: "05-mis"
      dependsOn:
        - dev_network

    - deployment: dev_aks
      environment: dev
      component: "aks"
      dependsOn:
        - dev_mis

    - deployment: ithc_genesis
      environment: ithc
      component: "00-genesis"

    - deployment:  ithc_network_rg
      environment:  ithc
      component: "07-network-rg"
      dependsOn:
        - ithc_genesis

    - deployment:  ithc_network
      environment:  ithc
      component: "01-network"
      dependsOn:
        - ithc_network_rg
    
    - deployment:  ithc_mis
      environment:  ithc
      component: "05-mis"
      dependsOn:
        - ithc_network

    - deployment:  ithc_aks
      environment:  ithc
      component: "aks"
      dependsOn:
        - ithc_mis

    - deployment: prod_genesis
      environment: prod
      component: "00-genesis"

    - deployment: prod_network_rg
      environment: prod
      component: "07-network-rg"
      dependsOn:
        - prod_genesis

    - deployment: prod_network
      environment: prod
      component: "01-network"
      dependsOn:
        - prod_network_rg
    
    - deployment: prod_mis
      environment: prod
      component: "05-mis"
      dependsOn:
        - prod_network

    - deployment: prod_aks
      environment: prod
      component: "aks"
      dependsOn:
        - prod_mis

    - deployment: ptl_genesis
      environment: ptl
      component: "00-genesis"

    - deployment: ptl_network_rg
      environment: ptl
      component: "07-network-rg"
      dependsOn:
        -     ptl_genesis

    - deployment:  ptl_network
      environment:  ptl
      component: "01-network"
      dependsOn:
        - ptl_network_rg
    
    - deployment: ptl_mis
      environment: ptl
      component: "05-mis"
      dependsOn:
        -  ptl_network

    - deployment: ptl_aks
      environment: ptl
      component: "aks"
      dependsOn:
        - ptl_mis
   
    - deployment: ptlsbox_genesis
      environment: ptlsbox
      component: "00-genesis"

    - deployment:  ptlsbox_network_rg
      environment: ptlsbox
      component: "07-network-rg"
      dependsOn:
        - ptlsbox_genesis

    - deployment:  ptlsbox_network
      environment:  ptlsbox
      component: "01-network"
      dependsOn:
        - ptlsbox_network_rg
    
    - deployment: ptlsbox_mis
      environment: ptlsbox
      component: "05-mis"
      dependsOn:
        - ptlsbox_network

    - deployment: ptlsbox_aks
      environment: ptlsbox
      component: "aks"
      dependsOn:
        - ptlsbox_mis

    - deployment: sbox_genesis
      environment: sbox
      component: "00-genesis"

    - deployment:  sbox_network_rg
      environment: sbox
      component: "07-network-rg"
      dependsOn:
        - sbox_genesis

    - deployment:  sbox_network
      environment:  sbox
      component: "01-network"
      dependsOn:
        - sbox_network_rg
    
    - deployment: sbox_mis
      environment: sbox
      component: "05-mis"
      dependsOn:
      -  sbox_network

    - deployment: sbox_aks
      environment: sbox
      component: "aks"
      dependsOn:
        - sbox_mis
 
    - deployment: stg_genesis
      environment: stg
      component: "00-genesis"

    - deployment: stg_network_rg
      environment: stg
      component: "07-network-rg"
      dependsOn:
        - stg_genesis

    - deployment: stg_network
      environment: stg
      component: "01-network"
      dependsOn:
        -  stg_network_rg
    
    - deployment: stg_mis
      environment: stg
      component: "05-mis"
      dependsOn:
        - stg_network

    - deployment: stg_aks
      environment: stg
      component: "aks"
      dependsOn:
        - stg_mis

    - deployment: test_genesis
      environment: test
      component: "00-genesis"

    - deployment: test_network_rg
      environment: test
      component: "07-network-rg"
      dependsOn:
        - test_genesis

    - deployment: test_network
      environment: test
      component: "01-network"
      dependsOn:
        - test_network_rg
    
    - deployment: test_mis
      environment: test
      component: "05-mis"
      dependsOn:
        - test_network

    - deployment: test_aks
      environment: test
      component: "aks"
      dependsOn:
        - test_mis  

stages:
  - ${{ each deployment in parameters.environment_components }}:
    - ${{ if eq(parameters.env, deployment.environment) }}:
      - stage: ${{ deployment.deployment }}
        dependsOn: ${{ deployment.dependsOn }}
        condition: succeeded()
        jobs:
          - job: TerraformPlanApply
            pool:
              vmImage: ${{ variables.agentPool }}
            steps:
              - template: steps/terraform.yaml@cnp-azuredevops-libraries
                parameters:
                  overrideAction: ${{ parameters.overrideAction }}
                  environment: ${{ deployment.environment }}
                  component: ${{ deployment.component }}
                  serviceConnection: ${{ variables.serviceConnection }}
                  terraformInitSubscription: ${{ variables.terraformInitSubscription }}
                  product: ${{ variables.product }}
                  kvConnectedServiceName: ${{ variables.serviceConnection }}
                  planCommandOptions: >
                    -var project=${{ variables.project }}
                    -var subscription_id=$(ARM_SUBSCRIPTION_ID)
                    -var environment=${{ deployment.environment }}
                    -var control_vault=$(controlKeyVault)
                    -lock=false

      - stage: BootStrapClusters-${{ parameters.env }}
        displayName: "BootStrap Clusters"
        dependsOn: ${{ parameters.env }}_aks
        jobs:
          - job: BootStrap
            variables:
              ${{ if eq(parameters['cluster'], 'All') }}:
                clusters: $[ stageDependencies.${{ parameters.env }}_aks.TerraformPlanApply.outputs['setClusterNumbers.clusterNumbers'] ]
              ${{ if ne(parameters['cluster'], 'All') }}:
                clusters: ${{ parameters.cluster }}
            steps:
              - template: pipeline-steps/bootstrap.yaml
                parameters:
                  environment: ${{ parameters.env }}
              
